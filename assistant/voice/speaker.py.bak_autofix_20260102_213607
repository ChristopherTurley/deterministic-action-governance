from __future__ import annotations

import os
import subprocess
from dataclasses import dataclass


@dataclass
class SpeakerConfig:
    enabled: bool = True
    voice: str | None = None
    rate: int | None = None


class Speaker:
    """
    macOS TTS speaker.
    Supports:
      - say(text)
      - say_blocking(text)
    """

    def __init__(self, config: SpeakerConfig | None = None) -> None:
        self.config = config or SpeakerConfig()
        self._proc: subprocess.Popen[str] | None = None

    def _cmd(self, text: str) -> list[str]:
        cmd = ["say"]
        if self.config.voice:
            cmd += ["-v", self.config.voice]
        if self.config.rate:
            cmd += ["-r", str(self.config.rate)]
        cmd.append(text)
        return cmd

    def stop(self) -> None:
        if self._proc and self._proc.poll() is None:
            try:
                self._proc.terminate()
            except Exception:
                pass
        self._proc = None

    def say(self, text: str) -> None:
        if not self.config.enabled:
            return
        text = (text or "").strip()
        if not text:
            return
        if os.environ.get("VERA_TTS", "1") in ("0", "false", "False"):
            return

        self.stop()
        try:
            self._proc = subprocess.Popen(self._cmd(text))
        except Exception:
            self._proc = None

    def say_blocking(self, text: str) -> None:
        if not self.config.enabled:
            return
        text = (text or "").strip()
        if not text:
            return
        if os.environ.get("VERA_TTS", "1") in ("0", "false", "False"):
            return

        try:
            subprocess.run(self._cmd(text), check=False)
        except Exception:
            pass
