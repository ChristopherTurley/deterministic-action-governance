from __future__ import annotations

import subprocess
from typing import Optional


class Speaker:
    """
    macOS 'say' wrapper with safe shutdown.

    - Track active Popen so we can terminate on shutdown (prevents teardown weirdness).
    - Always pass '--' before message so messages starting with '-' don't become flags.
    """

    def __init__(self, voice: Optional[str] = None) -> None:
        self.voice = voice
        self._proc: Optional[subprocess.Popen] = None

    def _cmd(self, text: str):
        text = (text or "").strip()
        if not text:
            return None
        if self.voice:
            return ["say", "-v", self.voice, "--", text]
        return ["say", "--", text]

    def close(self) -> None:
        p = self._proc
        self._proc = None
        if not p:
            return
        try:
            if p.poll() is None:
                p.terminate()
                try:
                    p.wait(timeout=0.6)
                except Exception:
                    try:
                        p.kill()
                    except Exception:
                        pass
        except Exception:
            pass

    def say_blocking(self, text: str) -> None:
        cmd = self._cmd(text)
        if not cmd:
            return
        # Ensure no previous 'say' is alive
        self.close()
        proc = subprocess.Popen(cmd)
        self._proc = proc
        try:
            proc.wait()
        finally:
            if self._proc is proc:
                self._proc = None

    def say(self, text: str) -> None:
        cmd = self._cmd(text)
        if not cmd:
            return
        self.close()
        self._proc = subprocess.Popen(cmd)

    def __del__(self) -> None:
        try:
            self.close()
        except Exception:
            pass
